<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends - FireChat Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="page-container">
        <div class="header">Friends</div>

        <div style="padding:15px; border-bottom:1px solid #eee;">
            <div style="display:flex; gap:10px;">
                <input id="search" class="input-field" placeholder="Search username..." style="margin:0;">
                <button id="add-btn" class="btn btn-primary">Add</button>
            </div>
        </div>

        <div id="requests" style="background:#fff1f2;"></div>
        <div id="list"></div>
    </div>

    <script type="module" src="nav.js"></script>
    
    <script type="module">
        import { auth, db } from "./config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, onSnapshot, addDoc, doc, setDoc, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentUser = null;

        // AUTH CHECK
        onAuthStateChanged(auth, u => {
            if(!u) {
                window.location.href = "index.html";
            } else {
                currentUser = u;
                loadFriends();
                loadRequests();
            }
        });

        // --- SEND FRIEND REQUEST ---
        document.getElementById('add-btn').onclick = async () => {
            const term = document.getElementById('search').value.toLowerCase().trim();
            if(!term) return;
            
            const snap = await getDocs(query(collection(db, "users"), where("username", "==", term)));
            if(snap.empty) return alert("User not found");
            
            const target = snap.docs[0].data();
            if(target.uid === currentUser.uid) return alert("You cannot add yourself.");
            
            // Send Request
            await addDoc(collection(db, "requests"), { 
                from: currentUser.uid, 
                fromName: auth.currentUser.email.split('@')[0], 
                to: target.uid, 
                status: 'pending' 
            });
            alert("Friend request sent!");
            document.getElementById('search').value = '';
        };

        // --- LOAD INCOMING REQUESTS ---
        function loadRequests() {
            onSnapshot(query(collection(db, "requests"), where("to", "==", currentUser.uid)), snap => {
                const el = document.getElementById('requests');
                el.innerHTML = '';
                snap.forEach(d => {
                    const req = d.data();
                    el.innerHTML += `
                    <div class="list-item">
                        <div class="info" style="font-size: 14px;">Req from: <b>${req.fromName}</b></div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="window.acc('${d.id}','${req.from}')" class="btn btn-primary" style="padding: 6px 12px; font-size:13px;">Accept</button>
                            <button onclick="window.rej('${d.id}')" class="btn" style="padding: 6px 12px; font-size:13px; background:#fef2f2; color:#dc2626; border:1px solid #fecaca;">Reject</button>
                        </div>
                    </div>`;
                });
            });
        }

        // --- ACCEPT FRIEND REQUEST (TWO-WAY SYNC) ---
        window.acc = async (rid, senderUid) => {
            try {
                // 1. Get both users' profile data
                const senderDoc = await getDoc(doc(db, "users", senderUid));
                const myDoc = await getDoc(doc(db, "users", currentUser.uid));
                
                // Fallbacks just in case data is missing
                const senderData = senderDoc.exists() ? senderDoc.data() : { username: "User", avatar: "" };
                const myData = myDoc.exists() ? myDoc.data() : { username: "User", avatar: "" };
                
                // 2. Add the sender to YOUR friends list
                await setDoc(doc(db, "users", currentUser.uid, "friends", senderUid), { 
                    uid: senderUid, 
                    username: senderData.username, 
                    avatar: senderData.avatar || senderData.username[0].toUpperCase() 
                });
                
                // 3. Add YOU to the SENDER'S friends list
                await setDoc(doc(db, "users", senderUid, "friends", currentUser.uid), { 
                    uid: currentUser.uid, 
                    username: myData.username, 
                    avatar: myData.avatar || myData.username[0].toUpperCase() 
                });
                
                // 4. Delete the pending request so it disappears from the list
                await deleteDoc(doc(db, "requests", rid));
                
                alert("Friend request accepted! You can now chat.");
            } catch (error) {
                console.error("Error accepting friend request:", error);
                alert("Failed to accept request. Check your internet connection.");
            }
        };

        // --- REJECT REQUEST ---
        window.rej = async (rid) => {
            if(confirm("Are you sure you want to reject this friend request?")) {
                // Simply delete the request without adding them to the friends list
                await deleteDoc(doc(db, "requests", rid));
            }
        };

        // --- LOAD FRIENDS LIST WITH LIVE AVATARS ---
        function loadFriends() {
            onSnapshot(collection(db, "users", currentUser.uid, "friends"), async (snap) => {
                const el = document.getElementById('list');
                el.innerHTML = '';
                
                for (let d of snap.docs) {
                    const f = d.data();
                    
                    // Fetch the live profile to get their latest picture
                    const userProfile = await getDoc(doc(db, "users", f.uid));
                    const liveAvatar = userProfile.exists() ? userProfile.data().avatar : f.avatar;
                    
                    // Check if avatar is an image URL or a letter
                    const avatarHTML = liveAvatar && liveAvatar.startsWith('http') 
                        ? `<img src="${liveAvatar}">` 
                        : (liveAvatar || f.username[0].toUpperCase());

                    el.innerHTML += `
                    <div class="list-item" onclick="location.href='chats.html?uid=${f.uid}'">
                        <div class="avatar">${avatarHTML}</div>
                        <div class="info"><h4>${f.username}</h4></div>
                    </div>`;
                }
            });
        }
    </script>
</body>
</html>