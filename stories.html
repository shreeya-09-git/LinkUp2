<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stories - FireChat Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="page-container">
        <div class="header">Stories</div>

        <div class="stories-scroll" id="stories-row">
            <div style="display:flex; flex-direction:column; align-items:center;" onclick="postStatus()">
                <div class="insta-ring" style="background: #e5e7eb;">
                    <div class="inner-avatar" style="color:#4f46e5; font-size:28px;">+</div>
                </div>
                <div class="story-user-text">Your Story</div>
            </div>
            </div>

        <div style="padding: 20px; text-align: center; color: #888; font-size: 14px; margin-top: 50px;">
            Tap a circle above to view stories.
        </div>
    </div>

    <div id="story-viewer" class="hidden">
        <div class="progress-container" id="progress-container"></div>
        
        <div class="viewer-header">
            <div class="viewer-user-info">
                <div id="viewer-avatar" style="width:30px; height:30px; background:white; color:black; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;"></div>
                <span id="viewer-username">Username</span>
                <span id="viewer-time" style="color:#aaa; font-weight:400; font-size:12px; margin-left:8px;"></span>
            </div>
            <button class="close-viewer" onclick="closeViewer()">&times;</button>
        </div>

        <div class="viewer-content">
            <div class="tap-left" onclick="prevStory()"></div>
            <div class="tap-right" onclick="nextStory()"></div>
            
            <div id="media-container" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
            <div class="viewer-text" id="viewer-caption"></div>
        </div>
    </div>

    <script type="module" src="nav.js"></script>
    <script type="module">
        import { auth, db } from "./config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CLOUDINARY CONFIG (KEEP YOURS HERE) ---
        const CLOUD_NAME = "divihazs2"; 
        const UPLOAD_PRESET = "linkup_media"; 

        let currentUser = null;
        let groupedStories = {}; // Stores { uid: [story1, story2] }
        let currentViewerUIDs = []; // Array of uids that have stories
        let activeUserIndex = 0;
        let activeStoryIndex = 0;
        let storyTimer = null;

        onAuthStateChanged(auth, u => { if(u) { currentUser = u; loadStories(); } });

        // --- FETCH & GROUP STORIES ---
        function loadStories() {
            // Get all stories, order by oldest first so they play in chronological order
            onSnapshot(query(collection(db, "stories"), orderBy("timestamp", "asc")), snap => {
                groupedStories = {};
                
                // Only show stories from the last 24 hours
                const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);

                snap.forEach(d => {
                    const s = d.data();
                    if(s.timestamp && s.timestamp.toMillis() > twentyFourHoursAgo) {
                        if (!groupedStories[s.uid]) groupedStories[s.uid] = [];
                        groupedStories[s.uid].push(s);
                    }
                });

                renderStoryRow();
            });
        }

        // --- RENDER THE TOP HORIZONTAL ROW ---
        function renderStoryRow() {
            const row = document.getElementById('stories-row');
            // Keep the "Add Story" button, remove everything else
            row.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; cursor:pointer;" onclick="postStatus()">
                    <div class="insta-ring" style="background: #e5e7eb;">
                        <div class="inner-avatar" style="color:#4f46e5; font-size:28px;">+</div>
                    </div>
                    <div class="story-user-text">Your Story</div>
                </div>
            `;

            currentViewerUIDs = Object.keys(groupedStories);

            currentViewerUIDs.forEach((uid, index) => {
                const userStories = groupedStories[uid];
                const latestStory = userStories[userStories.length - 1]; // Get name from most recent

                row.innerHTML += `
                    <div style="display:flex; flex-direction:column; align-items:center; cursor:pointer;" onclick="openViewer(${index})">
                        <div class="insta-ring">
                            <div class="inner-avatar">${latestStory.username[0].toUpperCase()}</div>
                        </div>
                        <div class="story-user-text">${latestStory.username}</div>
                    </div>
                `;
            });
        }

        // --- VIEWER LOGIC ---
        window.openViewer = (userIndex) => {
            document.getElementById('story-viewer').classList.remove('hidden');
            activeUserIndex = userIndex;
            activeStoryIndex = 0;
            playCurrentStory();
        };

        window.closeViewer = () => {
            document.getElementById('story-viewer').classList.add('hidden');
            clearTimeout(storyTimer);
            resetProgressBars();
        };

        window.nextStory = () => {
            clearTimeout(storyTimer);
            const userUid = currentViewerUIDs[activeUserIndex];
            const userStories = groupedStories[userUid];
            
            // If there are more stories for THIS user
            if (activeStoryIndex < userStories.length - 1) {
                activeStoryIndex++;
                playCurrentStory();
            } 
            // If there are more users
            else if (activeUserIndex < currentViewerUIDs.length - 1) {
                activeUserIndex++;
                activeStoryIndex = 0;
                playCurrentStory();
            } 
            // End of all stories
            else {
                closeViewer();
            }
        };

        window.prevStory = () => {
            clearTimeout(storyTimer);
            if (activeStoryIndex > 0) {
                activeStoryIndex--;
                playCurrentStory();
            } else if (activeUserIndex > 0) {
                activeUserIndex--;
                const prevUserUid = currentViewerUIDs[activeUserIndex];
                activeStoryIndex = groupedStories[prevUserUid].length - 1; // Go to their last story
                playCurrentStory();
            } else {
                // At the very beginning, just replay the first one
                playCurrentStory();
            }
        };

        function playCurrentStory() {
            const userUid = currentViewerUIDs[activeUserIndex];
            const userStories = groupedStories[userUid];
            const story = userStories[activeStoryIndex];

            // Setup Header
            document.getElementById('viewer-avatar').innerText = story.username[0].toUpperCase();
            document.getElementById('viewer-username').innerText = story.username;
            
            const diffMins = Math.floor((Date.now() - story.timestamp.toMillis()) / 60000);
            document.getElementById('viewer-time').innerText = diffMins > 60 ? Math.floor(diffMins/60) + 'h' : diffMins + 'm';

            // Setup Progress Bars
            setupProgressBars(userStories.length, activeStoryIndex);

            // Setup Content
            document.getElementById('viewer-caption').innerText = story.text || "";
            const mediaContainer = document.getElementById('media-container');
            
            if (story.mediaUrl) {
                if(story.mediaUrl.match(/\.(mp4|webm|ogg)$/i)) {
                    mediaContainer.innerHTML = `<video src="${story.mediaUrl}" autoplay playsinline style="max-width:100%; max-height:100%;"></video>`;
                } else {
                    mediaContainer.innerHTML = `<img src="${story.mediaUrl}">`;
                }
            } else {
                // Text-only story background
                mediaContainer.innerHTML = `<div style="width:100%; height:100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>`;
            }

            // Animate current progress bar and set timer
            setTimeout(() => {
                const currentBar = document.getElementById(`prog-${activeStoryIndex}`);
                if(currentBar) {
                    currentBar.style.transition = "width 5s linear";
                    currentBar.style.width = "100%";
                }
            }, 50);

            // Auto-advance after 5 seconds
            storyTimer = setTimeout(() => {
                nextStory();
            }, 5000);
        }

        function setupProgressBars(total, currentIndex) {
            const container = document.getElementById('progress-container');
            container.innerHTML = '';
            for(let i=0; i<total; i++) {
                let width = "0%";
                if (i < currentIndex) width = "100%"; // Past stories are full
                container.innerHTML += `<div class="progress-bar"><div id="prog-${i}" class="progress-fill" style="width:${width};"></div></div>`;
            }
        }

        function resetProgressBars() {
            document.getElementById('progress-container').innerHTML = '';
        }

        // --- POSTING A STORY (YOUR EXISTING CLOUDINARY LOGIC) ---
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*, video/*';

        window.postStatus = () => { fileInput.click(); };

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            const text = prompt("Add a caption to your story:");
            if (!file && !text) return;

            let mediaUrl = null;
            if (file) {
                alert("Uploading story... please wait.");
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);

                try {
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: formData });
                    const data = await res.json();
                    mediaUrl = data.secure_url; 
                } catch (err) {
                    alert("Failed to upload media.");
                    return; 
                }
            }

            await addDoc(collection(db, "stories"), {
                uid: currentUser.uid, text: text || "", mediaUrl: mediaUrl,
                timestamp: serverTimestamp(), username: currentUser.email.split('@')[0]
            });

            await updateDoc(doc(db, "users", currentUser.uid), { lastStoryAt: serverTimestamp() });
            alert("Story posted!");
            fileInput.value = ''; 
        };
    </script>
</body>
</html>