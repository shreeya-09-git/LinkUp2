<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - FireChat Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* Modal for the cropping tool */
        #crop-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(0,0,0,0.9); z-index: 100000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .crop-container { width: 100%; max-width: 400px; height: 400px; background: #111; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-actions { margin-top: 20px; display: flex; gap: 15px; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="header">Edit Profile</div>

        <div class="profile-header">
            <div class="profile-avatar-wrapper">
                <div class="profile-avatar" id="prof-avatar">?</div>
                <div class="edit-avatar-btn" onclick="document.getElementById('avatar-upload').click()">üì∑</div>
                <input type="file" id="avatar-upload" hidden accept="image/*">
            </div>
            <h2 id="prof-username-display" style="margin:0; font-size:20px;">Loading...</h2>
        </div>
        
        <div class="profile-form">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="edit-username" placeholder="Username">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="edit-email" disabled>
            </div>

            <div class="form-group" style="margin-bottom: 30px;">
                <label>App Theme</label>
                <select id="theme-selector" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Inter', sans-serif; background: transparent; color: inherit; cursor: pointer; outline: none;">
                    <option value="system" style="color: black;">üì± System Default</option>
                    <option value="light" style="color: black;">‚òÄÔ∏è Light</option>
                    <option value="dark" style="color: black;">üåô Dark</option>
                </select>
            </div>
            
            <button class="btn btn-primary" id="save-profile-btn" style="width:100%; padding:14px; margin-bottom:20px;">Save Changes</button>
            <button class="btn" id="logout-btn" style="width:100%; padding:14px; background:#fef2f2; color:#dc2626; border:1px solid #fecaca;">Log Out</button>
        </div>
    </div>

    <div id="crop-modal">
        <div class="crop-container">
            <img id="image-to-crop" src="">
        </div>
        <div class="crop-actions">
            <button id="cancel-crop" class="btn" style="background:#444; color:white;">Cancel</button>
            <button id="confirm-crop" class="btn btn-primary">Crop & Upload</button>
        </div>
    </div>

    <script type="module" src="nav.js"></script>
    
    <script type="module">
        import { auth, db } from "./config.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, updateDoc, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CLOUDINARY CONFIG ---
        const CLOUD_NAME = "divihazs2"; 
        const UPLOAD_PRESET = "linkup_media"; 

        let currentUser = null;
        let userData = null;
        let cropper = null; // Holds the cropper instance

        const saveBtn = document.getElementById('save-profile-btn');
        saveBtn.disabled = true;
        saveBtn.innerText = "Loading...";

        // Verify Auth & Load Data
        onAuthStateChanged(auth, async u => {
            if(!u) window.location.href = "index.html";
            else { currentUser = u; await loadUserProfile(); }
        });

        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    
                    document.getElementById('prof-username-display').innerText = "@" + userData.username;
                    document.getElementById('edit-username').value = userData.username;
                    document.getElementById('edit-email').value = userData.email;

                    const avatarEl = document.getElementById('prof-avatar');
                    if (userData.avatar && userData.avatar.startsWith("http")) {
                        avatarEl.innerHTML = `<img src="${userData.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else {
                        avatarEl.innerHTML = userData.avatar || userData.username[0].toUpperCase();
                    }

                    saveBtn.disabled = false;
                    saveBtn.innerText = "Save Changes";
                }
            } catch (err) { console.error(err); }
        }

        // --- 1. OPEN IMAGE IN CROPPER ---
        document.getElementById('avatar-upload').onchange = (e) => {
            const file = e.target.files[0];
            if(!file || !userData) return;

            // Read the file locally to show in the cropper
            const reader = new FileReader();
            reader.onload = (event) => {
                const imageEl = document.getElementById('image-to-crop');
                imageEl.src = event.target.result;
                
                // Show modal
                document.getElementById('crop-modal').style.display = 'flex';

                // Initialize Cropper.js
                if (cropper) cropper.destroy(); // Clear old cropper if exists
                cropper = new Cropper(imageEl, {
                    aspectRatio: 1, // Forces a perfect 1:1 square
                    viewMode: 1,    // Restricts crop box to image bounds
                    autoCropArea: 1
                });
            };
            reader.readAsDataURL(file);
            e.target.value = ''; // Reset input
        };

        // --- 2. CANCEL CROP ---
        document.getElementById('cancel-crop').onclick = () => {
            document.getElementById('crop-modal').style.display = 'none';
            if (cropper) cropper.destroy();
        };

        // --- 3. CONFIRM CROP & UPLOAD TO CLOUDINARY ---
        document.getElementById('confirm-crop').onclick = async () => {
            if (!cropper) return;

            const confirmBtn = document.getElementById('confirm-crop');
            confirmBtn.innerText = "Uploading...";
            confirmBtn.disabled = true;

            // Extract the cropped area as a Blob file
            cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(async (blob) => {
                try {
                    // Upload the cropped blob to Cloudinary
                    const formData = new FormData();
                    formData.append('file', blob, 'avatar.jpg');
                    formData.append('upload_preset', UPLOAD_PRESET);

                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: formData });
                    const data = await res.json();
                    const newAvatarUrl = data.secure_url;

                    // Save new URL to Firestore
                    await updateDoc(doc(db, "users", currentUser.uid), { avatar: newAvatarUrl });
                    
                    // Update UI immediately
                    document.getElementById('prof-avatar').innerHTML = `<img src="${newAvatarUrl}" style="width:100%; height:100%; object-fit:cover;">`;
                    userData.avatar = newAvatarUrl;
                    
                    alert("Profile picture updated!");
                } catch (err) {
                    alert("Failed to upload image.");
                } finally {
                    // Close modal and reset
                    document.getElementById('crop-modal').style.display = 'none';
                    if (cropper) cropper.destroy();
                    confirmBtn.innerText = "Crop & Upload";
                    confirmBtn.disabled = false;
                }
            }, 'image/jpeg'); // Export as standard JPEG
        };

        // --- SAVE PROFILE (USERNAME) ---
        saveBtn.onclick = async () => {
            if (!userData) return alert("Profile data hasn't loaded yet.");

            const newUsername = document.getElementById('edit-username').value.trim().toLowerCase();
            
            if(newUsername === userData.username) return alert("No changes made.");
            if(newUsername.length < 3) return alert("Username too short.");

            saveBtn.innerText = "Saving...";
            saveBtn.disabled = true;

            try {
                const q = query(collection(db, "users"), where("username", "==", newUsername));
                const snap = await getDocs(q);
                if(!snap.empty) throw new Error("Username is already taken.");

                await updateDoc(doc(db, "users", currentUser.uid), { username: newUsername });
                
                document.getElementById('prof-username-display').innerText = "@" + newUsername;
                userData.username = newUsername;
                alert("Profile updated successfully!");

            } catch(e) {
                alert(e.message);
            } finally {
                saveBtn.innerText = "Save Changes";
                saveBtn.disabled = false;
            }
        };

        // --- LOGOUT LOGIC ---
        document.getElementById('logout-btn').onclick = async () => {
            if(confirm("Are you sure you want to log out?")) {
                await signOut(auth);
                window.location.href = "index.html";
            }
        };
        
        // --- THEME SELECTOR LOGIC (BULLETPROOF) ---
        const themeSelector = document.getElementById('theme-selector');
        
        // 1. Set dropdown to currently saved theme
        themeSelector.value = localStorage.getItem('firechat-theme') || 'system';

        // 2. Force the theme change immediately when clicked
        themeSelector.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            localStorage.setItem('firechat-theme', selectedTheme);
            
            // Apply it directly to the HTML document right now
            if (selectedTheme === 'dark' || (selectedTheme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
            
            // Call the global nav.js function if it exists (for cross-tab syncing)
            if (typeof window.applyTheme === 'function') {
                window.applyTheme(selectedTheme); 
            }
        });
    </script>
</body>
</html>